CREATE DATABASE e_library;
USE e_library;
CREATE TABLE CATEGORY (
 CATEGORY_ID INT  NOT NULL AUTO_INCREMENT,
 CATEGORY_NAME VARCHAR(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL UNIQUE,
 CATEGORY_DESCRIPTION TEXT CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
 PRIMARY KEY(CATEGORY_ID)
);
CREATE TABLE STATUS (
 STATUS_ID TINYINT  NOT NULL AUTO_INCREMENT,
 STATUS_NAME VARCHAR(50) NOT NULL UNIQUE,
 PRIMARY KEY(STATUS_ID)
);
CREATE TABLE ROLE (
 ROLE_ID  TINYINT  NOT NULL AUTO_INCREMENT,
 ROLE_NAME VARCHAR(50) NOT NULL UNIQUE,
 PRIMARY KEY(ROLE_ID)
);
CREATE TABLE USER (
 USER_ID  INT  NOT NULL AUTO_INCREMENT,
 USER_NAME VARCHAR(50) NOT NULL UNIQUE,
 USER_PASSWORD VARCHAR(100) NOT NULL,
 USER_SALT VARCHAR(100) NOT NULL,
 USER_EMAIL VARCHAR(50) NOT NULL UNIQUE,
 USER_FULLNAME VARCHAR(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
 USER_ADDRESS VARCHAR(50) CHARACTER SET utf8 COLLATE utf8_general_ci,
 USER_PHONE VARCHAR(11),
 USER_DATE_CREATED DATETIME NOT NULL DEFAULT NOW(),
 USER_IS_ACTIVE  TINYINT  NOT NULL DEFAULT "1",
 USER_ROLE  TINYINT NOT NULL DEFAULT "3",

 PRIMARY KEY(USER_ID),
 
 FOREIGN KEY(USER_ROLE)
  REFERENCES ROLE(ROLE_ID)  
);
CREATE TABLE BOOK (
 BOOK_ID  INT  NOT NULL AUTO_INCREMENT,
 BOOK_NAME VARCHAR(100) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
 BOOK_AUTHOR VARCHAR(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
 BOOK_DESCRIPTION TEXT CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL,
 CATEGORY_ID INT  NOT NULL,
 BOOK_STATUS TINYINT  NOT NULL DEFAULT "1",
 FIRST_PAGE_URL VARCHAR(100) NOT NULL,
 BOOK_URL VARCHAR(100) NOT NULL,
 
 PRIMARY KEY(BOOK_ID),

 FOREIGN KEY(CATEGORY_ID)
  REFERENCES CATEGORY(CATEGORY_ID),
 FOREIGN KEY(BOOK_STATUS)
  REFERENCES STATUS(STATUS_ID)
);
CREATE TABLE USERACTION (
  ACTION_ID TINYINT NOT NULL AUTO_INCREMENT,
  ACTION_NAME VARCHAR(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL UNIQUE,
  
  PRIMARY KEY(ACTION_ID)
);
CREATE TABLE BOOKACTION (
  ACTION_ID TINYINT NOT NULL AUTO_INCREMENT,
  ACTION_NAME VARCHAR(50) CHARACTER SET utf8 COLLATE utf8_general_ci NOT NULL UNIQUE,
  
  PRIMARY KEY(ACTION_ID)
);
CREATE TABLE USERLOG (
 LOG_ID  INT  NOT NULL AUTO_INCREMENT,
 USER_ID  INT  NOT NULL,
 ACTION_ID TINYINT NOT NULL,
 LOG_DATE_CREATED DATETIME NOT NULL DEFAULT NOW(),
 IP_ADDRESS VARCHAR(15),  
 
 PRIMARY KEY(LOG_ID),
 
 FOREIGN KEY(ACTION_ID)
  REFERENCES USERACTION(ACTION_ID),
 FOREIGN KEY(USER_ID)
  REFERENCES USER(USER_ID)
);
CREATE TABLE BOOKLOG (
  LOG_ID INT NOT NULL AUTO_INCREMENT,
  USER_ID INT NOT NULL,
  BOOK_ID INT NOT NULL,
  ACTION_ID TINYINT NOT NULL,
  LOG_DATE_CREATED DATETIME NOT NULL DEFAULT NOW(),
  
  PRIMARY KEY(LOG_ID),
  FOREIGN KEY(USER_ID)
  REFERENCES USER(USER_ID),
  FOREIGN KEY(BOOK_ID)
  REFERENCES BOOK(BOOK_ID),
  FOREIGN KEY (ACTION_ID)
  REFERENCES BOOKACTION(ACTION_ID)
);

INSERT INTO CATEGORY(CATEGORY_NAME,CATEGORY_DESCRIPTION) VALUES
("cnnt","cnnt"),
("dien","dien"),
("nhiet","nhiet");

INSERT INTO STATUS(STATUS_NAME) VALUES
("Waiting"),
("Approved"),
("Rejected");

INSERT INTO ROLE(ROLE_NAME) VALUES
("Admin"),
("Librarian"),
("User");

INSERT INTO USERACTION(ACTION_NAME) VALUES
("Login"),
("Logout"),
("Changed info");

INSERT INTO BOOKACTION(ACTION_NAME) VALUES
("Uploaded"),
("Downloaded"),
("Added_favorite"),
("Approved"),
("Rejected"),
("Edited");

INSERT INTO USER(USER_NAME,USER_PASSWORD,USER_SALT,USER_EMAIL,USER_FULLNAME,USER_ADDRESS,USER_PHONE,USER_ROLE) VALUES
("admin","admin","admin","admin@gmail","ad","ad","01234123123","1"),
("tt1","tt1","tt1","tt1@gmail","tt1","tt1","0123321321","2");
INSERT INTO USER(USER_NAME,USER_PASSWORD,USER_SALT,USER_EMAIL,USER_FULLNAME,USER_ADDRESS,USER_PHONE) VALUES
("u1","u1","u1","u1@gmail","u1","u1","0321321321"),
("u2","u2","u2","u2@gmail","u2","u2","0321321322"),
("u3","u3","u3","u3@gmail","u3","u3","0321321323");

INSERT INTO BOOK(BOOK_NAME,BOOK_AUTHOR,BOOK_DESCRIPTION,CATEGORY_ID,BOOK_URL) VALUES
("abc","abc","abc","1","abc"),
("adc","adc","adc","2","adc"),
("xzc","xzc","xzc","3","xzc");

-- upload
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("3","1","1");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("3","2","1");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("3","3","1");
SELECT SLEEP(1);

-- approved
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("2","1","4");
UPDATE BOOK SET BOOK_STATUS="2" WHERE BOOK_ID="1";
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("2","2","4");
UPDATE BOOK SET BOOK_STATUS="2" WHERE BOOK_ID="2";
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("2","3","4");
UPDATE BOOK SET BOOK_STATUS="2" WHERE BOOK_ID="3";
SELECT SLEEP(1);


-- download
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("3","1","2");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("3","1","2");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("3","1","2");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("4","1","2");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("5","1","2");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("5","2","2");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("5","2","2");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("4","3","2");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("3","2","2");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("3","2","2");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("3","3","2");
SELECT SLEEP(1);


-- add favorite
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("4","3","3");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("4","2","3");
SELECT SLEEP(1);
INSERT INTO BOOKLOG(USER_ID,BOOK_ID,ACTION_ID) VALUES
("4","1","2");
SELECT SLEEP(1);



-- User XXX đã upload sách nào
SELECT BOOK.BOOK_ID, BOOK_NAME, LOG_DATE_CREATED FROM BOOK, BOOKLOG, USER, BOOKACTION WHERE BOOK.BOOK_ID = BOOKLOG.BOOK_ID AND BOOKLOG.USER_ID = USER.USER_ID AND BOOKLOG.ACTION_ID = BOOKACTION.ACTION_ID AND  USER_NAME = "u1" AND ACTION_NAME = "upload";

-- User XXX đã download sách nào
SELECT BOOK.BOOK_ID, BOOK_NAME, MAX(LOG_DATE_CREATED) FROM BOOK, BOOKLOG, USER, BOOKACTION WHERE BOOK.BOOK_ID = BOOKLOG.BOOK_ID AND BOOKLOG.USER_ID = USER.USER_ID AND BOOKLOG.ACTION_ID = BOOKACTION.ACTION_ID AND USER_NAME = "u1" AND ACTION_NAME = "download" GROUP BY BOOK.BOOK_ID, BOOK_NAME;

-- Book XXX đã được tải bởi user nào

SELECT DISTINCT USER.USER_ID, USER.USER_NAME FROM BOOK,BOOKLOG,BOOKACTION, USER WHERE BOOK.BOOK_ID = BOOKLOG.BOOK_ID AND  BOOKLOG.ACTION_ID = BOOKACTION.ACTION_ID AND  BOOKLOG.USER_ID = USER.USER_ID AND ACTION_NAME = "download" AND BOOK_NAME="abc";

-- Thông kê sách theo lượt tải (nhiều nhất)

SELECT BOOK_NAME, COUNT(USER_ID) AS SOLANTAI FROM BOOK, BOOKLOG, BOOKACTION WHERE BOOK.BOOK_ID = BOOKLOG.BOOK_ID AND  BOOKLOG.ACTION_ID = BOOKACTION.ACTION_ID  AND ACTION_NAME = "download"  GROUP BY BOOK.BOOK_ID ORDER BY SOLANTAI DESC;

-- User XXX đã thích sách nào

SELECT BOOK.BOOK_ID, BOOK_NAME, LOG_DATE_CREATED FROM BOOK, BOOKLOG, USER, BOOKACTION WHERE BOOK.BOOK_ID = BOOKLOG.BOOK_ID AND BOOKLOG.USER_ID = USER.USER_ID AND BOOKLOG.ACTION_ID = BOOKACTION.ACTION_ID AND  USER_NAME = "u2" AND ACTION_NAME = "add favorite";

-- User xxx đã duyệt(ko duyệt) sách nào

SELECT BOOK.BOOK_ID, BOOK_NAME, LOG_DATE_CREATED FROM BOOK, BOOKLOG, USER, BOOKACTION WHERE BOOK.BOOK_ID = BOOKLOG.BOOK_ID AND BOOKLOG.USER_ID = USER.USER_ID AND BOOKLOG.ACTION_ID = BOOKACTION.ACTION_ID AND  USER_NAME = "tt1" AND ACTION_NAME = "approved";

-- Thông kê sách chờ được duyệt(tên sách, người upload, thời gian)

SELECT BOOK_NAME, USER_NAME, LOG_DATE_CREATED FROM BOOK, BOOKLOG, USER, BOOKACTION, STATUS WHERE BOOK.BOOK_ID = BOOKLOG.BOOK_ID AND BOOKLOG.USER_ID = USER.USER_ID AND BOOKLOG.ACTION_ID = BOOKACTION.ACTION_ID AND BOOK_STATUS = STATUS_ID AND ACTION_NAME = "upload" AND STATUS_NAME="cho duyet";















